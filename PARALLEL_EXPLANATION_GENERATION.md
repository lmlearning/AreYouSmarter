# Parallel Explanation Generation Instructions

**Goal:** Generate high-quality AI explanations for MMLU questions in parallel across multiple LLM workers.

**Current Progress:** Check `/home/user/AreYouSmarter/server/data/ai-explanations.json` for current count.

**Target:** 14,042 total explanations

---

## Coordination Mechanism

### Before Starting Work

1. **Check current progress:**
   ```bash
   node get-batch.mjs 1
   ```
   This shows total completed and remaining questions.

2. **Claim a batch:**
   Create a claim file to reserve questions:
   ```bash
   # Claim questions START to END (batch of 15-20 recommended)
   echo "$(date -Iseconds)|$(hostname)|WORKER_ID" > /tmp/claims/claim_START_END.txt
   ```

   Example: Claiming questions 3000-3019:
   ```bash
   mkdir -p /tmp/claims
   echo "$(date -Iseconds)|$(hostname)|worker_1" > /tmp/claims/claim_3000_3019.txt
   ```

3. **Check for conflicts:**
   ```bash
   # List all active claims
   ls -lah /tmp/claims/

   # Remove stale claims (older than 2 hours)
   find /tmp/claims -name "claim_*.txt" -mmin +120 -delete
   ```

4. **Get your batch:**
   ```bash
   node get-batch.mjs 20 > /tmp/my_batch_START_END.json
   ```

### After Completing Work

1. **Append to main file**
2. **Commit and push**
3. **Remove your claim:**
   ```bash
   rm /tmp/claims/claim_START_END.txt
   ```

---

## Quality Standards

### Explanation Structure

Each explanation must include:

```json
{
  "questionId": "subject_number",
  "explanation": "Detailed educational explanation with context, reasoning, examples",
  "reasoning": "Concise summary of logic (1-3 sentences)",
  "steps": [
    "Step 1 of logical reasoning",
    "Step 2",
    "Step 3",
    "Answer: [letter/option]"
  ],
  "generatedAt": "ISO-8601 timestamp"
}
```

### Explanation Requirements

**DO:**
- ✅ Provide detailed educational content (3-10 paragraphs)
- ✅ Include problem setup and context
- ✅ Show step-by-step reasoning with explicit calculations
- ✅ Explain WHY an answer is correct, not just WHAT it is
- ✅ Use proper terminology
- ✅ Include examples where helpful
- ✅ Note if marked answer appears incorrect (document the discrepancy)
- ✅ Make it educational - someone should learn from reading

**DON'T:**
- ❌ Just restate the answer
- ❌ Be brief or superficial
- ❌ Skip mathematical steps or calculations
- ❌ Ignore context or background
- ❌ Use emojis (unless user specifically requested)

### Quality Examples

**GOOD - Abstract Algebra:**
```json
{
  "questionId": "abstract_algebra_42",
  "explanation": "We need to find the order of the cyclic subgroup ⟨25⟩ in Z₃₀. The order of a cyclic subgroup generated by an element a in Zₙ is given by |⟨a⟩| = n/gcd(n,a).\n\nFor ⟨25⟩ in Z₃₀:\n- n = 30\n- a = 25\n- gcd(30, 25) = ?\n\nUsing the Euclidean algorithm:\n30 = 1·25 + 5\n25 = 5·5 + 0\n\nTherefore gcd(30, 25) = 5.\n\nThe order is |⟨25⟩| = 30/5 = 6.\n\nWe can verify: ⟨25⟩ = {0, 25, 50 mod 30, 75 mod 30, 100 mod 30, 125 mod 30} = {0, 25, 20, 15, 10, 5}, which indeed has 6 elements.\n\n[Continue with more detail about cyclic groups, why the formula works, etc.]",
  "reasoning": "Order formula: |⟨a⟩| = n/gcd(n,a) = 30/gcd(30,25) = 30/5 = 6. The subgroup has 6 elements.",
  "steps": [
    "|⟨25⟩| in Z₃₀ = 30/gcd(30,25)",
    "gcd(30,25): 30 = 1·25 + 5",
    "25 = 5·5 + 0",
    "gcd(30,25) = 5",
    "|⟨25⟩| = 30/5 = 6",
    "Answer: 6"
  ],
  "generatedAt": "2025-01-10T12:30:00.000Z"
}
```

**BAD - Too Brief:**
```json
{
  "questionId": "abstract_algebra_42",
  "explanation": "Use the formula n/gcd(n,a) to get 30/5 = 6.",
  "reasoning": "30/5 = 6",
  "steps": ["Calculate gcd", "Divide", "Answer: 6"],
  "generatedAt": "2025-01-10T12:30:00.000Z"
}
```
❌ This is too superficial - no educational value, no context, no explanation of concepts.

---

## Subject-Specific Guidelines

### Mathematics (Abstract Algebra, Statistics, etc.)
- Show ALL calculation steps explicitly
- Define mathematical concepts used
- Explain theorems/formulas applied
- Verify answers when possible
- Note if marked answer contradicts calculation

### Geography
- Provide historical/political context
- Explain geographic patterns and processes
- Include examples from multiple regions
- Define key terms (formal region, nation-state, etc.)
- Note if marked answer is factually incorrect

### Sciences
- Explain scientific principles
- Show problem-solving methodology
- Include relevant examples
- Define technical terms

### Humanities
- Provide historical/cultural context
- Explain significance
- Multiple perspectives when relevant

---

## Workflow

### 1. Claim Your Batch
```bash
# Create claim
mkdir -p /tmp/claims
BATCH_START=3000
BATCH_END=3019
WORKER_ID="worker_$(hostname)_$$"

echo "$(date -Iseconds)|$(hostname)|${WORKER_ID}" > /tmp/claims/claim_${BATCH_START}_${BATCH_END}.txt

# Verify no conflict
ls /tmp/claims/claim_${BATCH_START}_*.txt
# Should only show your file
```

### 2. Get Questions
```bash
cd /home/user/AreYouSmarter
node get-batch.mjs 20 > /tmp/my_batch_${BATCH_START}_${BATCH_END}.json

# Review questions
cat /tmp/my_batch_${BATCH_START}_${BATCH_END}.json | python3 -m json.tool | head -50
```

### 3. Generate Explanations

Create explanations following quality standards above. Use this template:

```python
import json
from datetime import datetime

# Load questions
with open('/tmp/my_batch_START_END.json', 'r') as f:
    data = json.load(f)
    questions = data['batch']

# Generate explanations
explanations = []
for q in questions:
    explanation = {
        "questionId": q['id'],
        "explanation": """
        [YOUR DETAILED EXPLANATION HERE - 3-10 paragraphs]
        - Problem context and setup
        - Relevant background concepts
        - Step-by-step reasoning with calculations
        - Examples if helpful
        - Why this answer is correct
        - Note any discrepancies with marked answer
        """,
        "reasoning": "[Concise 1-3 sentence summary]",
        "steps": [
            "Clear step 1",
            "Clear step 2",
            "...",
            "Answer: [result]"
        ],
        "generatedAt": datetime.utcnow().isoformat() + 'Z'
    }
    explanations.append(explanation)

# Save batch
with open('/tmp/generated_batch_START_END.json', 'w') as f:
    json.dump(explanations, f, indent=2)
```

### 4. Append to Main File
```python
import json

# Load main file
with open('/home/user/AreYouSmarter/server/data/ai-explanations.json', 'r') as f:
    all_explanations = json.load(f)

# Load your batch
with open('/tmp/generated_batch_START_END.json', 'r') as f:
    new_batch = json.load(f)

print(f"Before: {len(all_explanations)}")
all_explanations.extend(new_batch)
print(f"After: {len(all_explanations)}")

# Save back
with open('/home/user/AreYouSmarter/server/data/ai-explanations.json', 'w') as f:
    json.dump(all_explanations, f, indent=2)

print(f"Progress: {len(all_explanations)}/14042 = {len(all_explanations)/14042*100:.2f}%")
```

### 5. Commit and Push
```bash
git add server/data/ai-explanations.json

# Commit with descriptive message
git commit -m "$(cat <<'EOF'
Add [N] AI explanations ([OLD]→[NEW], [PERCENT]%)

Generated comprehensive explanations for:
- [subject]_[start]-[end] ([count] questions)

Covered [key topics listed briefly].

Worker: [WORKER_ID]
EOF
)"

# Push with retry logic
git push -u origin claude/precompute-ai-explanations-011CUzpKujAXgqfipY1P1QLy || \
  (sleep 2 && git push -u origin claude/precompute-ai-explanations-011CUzpKujAXgqfipY1P1QLy)
```

### 6. Clean Up
```bash
# Remove your claim
rm /tmp/claims/claim_${BATCH_START}_${BATCH_END}.txt

# Remove temp files
rm /tmp/my_batch_${BATCH_START}_${BATCH_END}.json
rm /tmp/generated_batch_${BATCH_START}_${BATCH_END}.json
```

---

## Handling Conflicts

### If You Encounter a Git Conflict

```bash
# Pull latest changes
git fetch origin claude/precompute-ai-explanations-011CUzpKujAXgqfipY1P1QLy
git pull origin claude/precompute-ai-explanations-011CUzpKujAXgqfipY1P1QLy

# Re-append your batch (main file has changed)
python3 << 'EOF'
import json

# Load updated main file
with open('server/data/ai-explanations.json', 'r') as f:
    all_explanations = json.load(f)

# Load your batch
with open('/tmp/generated_batch_START_END.json', 'r') as f:
    new_batch = json.load(f)

# Check for duplicates
existing_ids = {e['questionId'] for e in all_explanations}
new_explanations = [e for e in new_batch if e['questionId'] not in existing_ids]

if not new_explanations:
    print("All questions already explained by another worker!")
else:
    print(f"Adding {len(new_explanations)} new explanations")
    all_explanations.extend(new_explanations)

    with open('server/data/ai-explanations.json', 'w') as f:
        json.dump(all_explanations, f, indent=2)
EOF

# Commit and push again
git add server/data/ai-explanations.json
git commit -m "Add [N] explanations (resolved conflict)"
git push -u origin claude/precompute-ai-explanations-011CUzpKujAXgqfipY1P1QLy
```

---

## Coordination Tips

### Minimize Conflicts

1. **Claim before starting** - Always create claim file first
2. **Work on different ranges** - Coordinate rough ranges (e.g., Worker 1: 3000-4000, Worker 2: 4000-5000)
3. **Small batches** - 15-20 questions per batch reduces conflict window
4. **Quick turnaround** - Generate, append, commit, push quickly
5. **Check claims** - Before claiming, check existing claims:
   ```bash
   ls -lah /tmp/claims/
   ```

### Suggested Range Assignments (Flexible)

If starting fresh with multiple workers, roughly divide:

- **Worker 1:** Questions 2825-5000
- **Worker 2:** Questions 5000-7500
- **Worker 3:** Questions 7500-10000
- **Worker 4:** Questions 10000-12500
- **Worker 5:** Questions 12500-14042

But use the claim system, not rigid boundaries. If you finish your range, claim from others' ranges.

### Communication (Optional)

If workers can communicate:
- Share progress updates
- Coordinate on subject areas
- Report issues or answer key problems
- Share particularly tricky questions

---

## Quality Checklist

Before committing your batch, verify:

- [ ] Each explanation is 3-10 paragraphs (detailed)
- [ ] Shows step-by-step reasoning with calculations
- [ ] Includes context and background concepts
- [ ] Explains WHY, not just WHAT
- [ ] Uses proper terminology
- [ ] Reasoning field summarizes concisely (1-3 sentences)
- [ ] Steps array has clear logical progression
- [ ] generatedAt timestamp is ISO-8601 format
- [ ] No emojis (unless specifically requested)
- [ ] Notes any discrepancies with marked answers
- [ ] Educational value - someone learns from reading

---

## Common Issues

### Issue: "Question already has explanation"
**Solution:** Another worker already did it. Skip and get next batch.

### Issue: "Marked answer seems wrong"
**Solution:** Document in explanation:
```
The marked answer is [X], but based on [calculation/reasoning],
the correct answer should be [Y]. [Explain the discrepancy].
```

### Issue: "Batch size too large"
**Solution:** Use smaller batches (10-15 questions) for faster turnaround.

### Issue: "Git push fails"
**Solution:**
1. Pull latest: `git pull origin claude/precompute-ai-explanations-011CUzpKujAXgqfipY1P1QLy`
2. Re-append (check for duplicates)
3. Commit and push again

---

## Examples of Good Explanations

See the existing explanations in `/home/user/AreYouSmarter/server/data/ai-explanations.json` for examples, particularly:

- `abstract_algebra_85-99` - Good mathematical explanations
- `high_school_geography_0-98` - Good geographic/conceptual explanations

Study these for tone, detail level, and structure.

---

## Progress Tracking

Check overall progress anytime:
```bash
cd /home/user/AreYouSmarter
python3 << 'EOF'
import json
with open('server/data/ai-explanations.json', 'r') as f:
    explanations = json.load(f)
total = 14042
completed = len(explanations)
remaining = total - completed
percent = completed / total * 100
print(f"Progress: {completed}/{total} ({percent:.2f}%)")
print(f"Remaining: {remaining}")
print(f"Active claims: {len([f for f in os.listdir('/tmp/claims') if f.startswith('claim_')])} batches")
EOF
```

---

## Success Metrics

- **Quality over speed** - Better to do 10 excellent explanations than 50 poor ones
- **Consistency** - Follow the format and standards
- **Completeness** - All 14,042 questions need explanations
- **Educational value** - Each explanation should teach something

---

## Getting Help

If you encounter issues:
1. Check existing explanations for examples
2. Review this document
3. Check git log for recent commits to see patterns
4. When in doubt, be MORE detailed rather than less

---

**Remember:** The goal is to create high-quality educational explanations that help users understand not just the answer, but the underlying concepts and reasoning. Take your time and make each explanation valuable!
